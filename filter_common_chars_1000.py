import os
import shutil
import pickle
import time

# 配置
char_dict_path = 'char_dict'
input_data_dir = 'data'
output_common_dir = 'data_common'
output_other_dir = 'data_other'

# 常用汉字列表（约1000个）
# 基于《通用规范汉字表》和常用字频率统计
common_chars = [
    # 一级常用字（约3500个中的前1000个）
    '一', '乙', '二', '十', '丁', '厂', '七', '卜', '人', '入',
    '八', '九', '几', '儿', '了', '力', '乃', '刀', '又', '三',
    '于', '干', '亏', '士', '工', '土', '才', '寸', '下', '大',
    '丈', '与', '万', '上', '小', '口', '巾', '山', '千', '乞',
    '川', '亿', '个', '勺', '久', '凡', '及', '夕', '丸', '么',
    '广', '亡', '门', '义', '之', '尸', '弓', '己', '已', '子',
    '卫', '也', '女', '飞', '刃', '习', '叉', '马', '乡', '丰',
    '王', '井', '开', '夫', '天', '无', '元', '专', '云', '扎',
    '艺', '木', '五', '支', '厅', '不', '太', '犬', '区', '历',
    '尤', '友', '匹', '车', '巨', '牙', '屯', '比', '互', '切',
    '瓦', '止', '少', '日', '中', '冈', '贝', '内', '水', '见',
    '午', '牛', '手', '毛', '气', '升', '长', '仁', '什', '片',
    '仆', '化', '仇', '币', '仍', '仅', '斤', '爪', '反', '介',
    '父', '从', '今', '凶', '分', '乏', '公', '仓', '月', '氏',
    '勿', '欠', '风', '丹', '匀', '乌', '凤', '勾', '文', '六',
    '方', '火', '为', '斗', '忆', '计', '订', '户', '认', '心',
    '尺', '引', '丑', '巴', '孔', '队', '办', '以', '允', '予',
    '劝', '双', '书', '幻', '玉', '刊', '示', '末', '未', '击',
    '打', '巧', '正', '扑', '扒', '功', '扔', '去', '甘', '世',
    '古', '节', '本', '术', '可', '丙', '左', '厉', '右', '石',
    '布', '龙', '平', '灭', '轧', '东', '卡', '北', '占', '业',
    '旧', '帅', '归', '且', '旦', '目', '叶', '甲', '申', '叮',
    '电', '号', '田', '由', '史', '只', '央', '兄', '叼', '叫',
    '另', '叨', '叹', '四', '生', '失', '禾', '丘', '付', '仗',
    '代', '仙', '们', '仪', '白', '仔', '他', '斥', '瓜', '乎',
    '丛', '令', '用', '甩', '印', '乐', '句', '匆', '册', '犯',
    '外', '处', '冬', '鸟', '务', '包', '饥', '主', '市', '立',
    '闪', '兰', '半', '汁', '汇', '头', '汉', '宁', '穴', '它',
    '讨', '写', '让', '礼', '训', '必', '议', '讯', '记', '永',
    '司', '尼', '民', '出', '辽', '奶', '奴', '加', '召', '皮',
    '边', '发', '孕', '圣', '对', '台', '矛', '纠', '母', '幼',
    '丝', '式', '刑', '动', '扛', '寺', '吉', '扣', '考', '托',
    '老', '执', '巩', '圾', '扩', '扫', '地', '扬', '场', '耳',
    '共', '芒', '亚', '芝', '朽', '朴', '机', '权', '过', '臣',
    '再', '协', '西', '压', '厌', '在', '有', '百', '存', '而',
    '页', '匠', '夸', '夺', '灰', '达', '列', '死', '成', '夹',
    '轨', '邪', '划', '迈', '毕', '此', '贞', '师', '尘', '尖',
    '劣', '光', '当', '早', '吐', '吓', '虫', '曲', '团', '同',
    '吊', '吃', '因', '吸', '吗', '屿', '帆', '岁', '回', '岂',
    '刚', '则', '肉', '网', '年', '朱', '先', '丢', '舌', '竹',
    '迁', '乔', '伟', '传', '乒', '乓', '休', '伍', '伏', '优',
    '伐', '延', '件', '任', '伤', '价', '份', '华', '仰', '仿',
    '伙', '伪', '自', '血', '向', '似', '后', '行', '舟', '全',
    '会', '杀', '合', '兆', '企', '众', '爷', '伞', '创', '肌',
    '朵', '杂', '危', '旬', '旨', '负', '各', '名', '多', '争',
    '色', '壮', '冲', '冰', '庄', '庆', '亦', '刘', '齐', '交',
    '次', '衣', '产', '决', '充', '妄', '闭', '问', '闯', '羊',
    '并', '关', '米', '灯', '州', '汗', '污', '江', '池', '汤',
    '忙', '兴', '宇', '守', '宅', '字', '安', '讲', '军', '许',
    '论', '农', '讽', '设', '访', '寻', '那', '迅', '尽', '导',
    '异', '孙', '阵', '阳', '收', '阶', '阴', '防', '奸', '如',
    '妇', '好', '她', '妈', '戏', '羽', '观', '欢', '买', '红',
    '纤', '级', '约', '纪', '驰', '巡', '寿', '弄', '麦', '形',
    '进', '戒', '吞', '远', '违', '运', '扶', '抚', '坛', '技',
    '坏', '扰', '拒', '找', '批', '扯', '址', '走', '抄', '坝',
    '贡', '攻', '赤', '折', '抓', '扮', '抢', '孝', '均', '抛',
    '投', '坟', '抗', '坊', '抖', '护', '壳', '志', '扭', '块',
    '声', '把', '报', '却', '劫', '芽', '花', '芹', '芬', '芳',
    '严', '芦', '劳', '克', '苏', '杆', '杠', '杜', '材', '村',
    '杖', '杏', '杉', '巫', '极', '李', '杨', '杈', '求', '步',
    '更', '束', '豆', '两', '丽', '医', '辰', '励', '否', '还',
    '歼', '来', '连', '步', '坚', '旱', '盯', '呈', '时', '吴',
    '助', '县里', '吞', '吟', '含', '谷', '邻', '岔', '肝', '肚',
    '肠', '龟', '免', '狂', '犹', '角', '删', '条', '卵', '岛',
    '迎', '饭', '饮', '系', '言', '冻', '状', '亩', '况', '床',
    '库', '疗', '应', '冷', '这', '序', '辛', '弃', '冶', '忘',
    '闲', '间', '闷', '判', '灶', '灿', '弟', '汪', '沙', '汽',
    '沃', '泛', '沟', '没', '沈', '沉', '怀', '忧', '快', '完',
    '宋', '宏', '牢', '究', '穷', '灾', '良', '证', '启', '评',
    '补', '初', '社', '识', '诉', '诊', '词', '译', '君', '灵',
    '即', '层', '尿', '尾', '迟', '局', '改', '张', '忌', '际',
    '陆', '阿', '陈', '阻', '附', '妙', '妖', '妨', '努', '忍',
    '劲', '鸡', '驱', '纯', '纱', '纳', '纲', '驳', '纵', '纷',
    '纸', '纹', '纺', '驴', '纽', '奉', '玩', '环', '武', '青',
    '责', '现', '表', '规', '抹', '拢', '拔', '拣', '担', '坦',
    '押', '抽', '拐', '拖', '拍', '者', '顶', '拆', '拥', '抵',
    '拘', '势', '抱', '垃', '拉', '拦', '拌', '幸', '招', '坡',
    '披', '拨', '择', '抬', '其', '取', '苦', '若', '茂', '苹',
    '苗', '英', '范', '茄', '茅', '林', '枝', '杯', '柜', '析',
    '板', '松', '枪', '构', '杰', '述', '枕', '丧', '或', '画',
    '卧', '事', '刺', '枣', '雨', '卖', '矿', '码', '厕', '奔',
    '奇', '奋', '态', '欧', '垄', '妻', '轰', '顷', '转', '斩',
    '轮', '软', '到', '非', '叔', '肯', '齿', '些', '虎', '虏',
    '肾', '贤', '尚', '旺', '具', '果', '味', '昆', '国', '昌',
    '畅', '明', '易', '昂', '典', '固', '忠', '咐', '呼', '鸣',
    '咏', '呢', '岸', '岩', '帖', '罗', '帜', '岭', '凯', '败',
    '贩', '购', '图', '钓', '制', '知', '垂', '牧', '物', '乖',
    '刮', '秆', '和', '季', '委', '佳', '侍', '供', '使', '例',
    '版', '侄', '侦', '侧', '凭', '侨', '佩', '货', '依', '的',
    '迫', '质', '欣', '征', '往', '爬', '彼', '径', '所', '舍',
    '金', '命', '斧', '爸', '采', '觅', '受', '乳', '贪', '念',
    '贫', '肤', '肺', '肢', '肿', '胀', '朋', '股', '肥', '服',
    '胁', '周', '昏', '鱼', '兔', '狐', '忽', '狗', '备', '饰',
    '饱', '饲', '变', '京', '享', '店', '夜', '庙', '府', '底',
    '剂', '郊', '废', '净', '盲', '放', '刻', '育', '闸', '闹',
    '郑', '券', '卷', '单', '炒', '炊', '炕', '炎', '炉', '沫',
    '浅', '法', '泄', '沿', '泡', '注', '泻', '泳', '泥', '沸',
    '波', '泼', '泽', '治', '怖', '性', '怕', '怜', '怪', '学',
    '宝', '宗', '定', '宜', '审', '宙', '官', '空', '帘', '实',
    '试', '郎', '诗', '肩', '房', '诚', '衬', '衫', '视', '话',
    '诞', '询', '该', '详', '诧', '诌', '词', '译', '君', '灵',
    '即', '层', '尿', '尾', '迟', '局', '改', '张', '忌', '际',
    '陆', '阿', '陈', '阻', '附', '妙', '妖', '妨', '努', '忍',
    '劲', '鸡', '驱', '纯', '纱', '纳', '纲', '驳', '纵', '纷',
    '纸', '纹', '纺', '驴', '纽', '奉', '玩', '环', '武', '青',
    '责', '现', '表', '规', '抹', '拢', '拔', '拣', '担', '坦',
    '押', '抽', '拐', '拖', '拍', '者', '顶', '拆', '拥', '抵',
    '拘', '势', '抱', '垃', '拉', '拦', '拌', '幸', '招', '坡',
    '披', '拨', '择', '抬', '其', '取', '苦', '若', '茂', '苹',
    '苗', '英', '范', '茄', '茅', '林', '枝', '杯', '柜', '析',
    '板', '松', '枪', '构', '杰', '述', '枕', '丧', '或', '画',
    '卧', '事', '刺', '枣', '雨', '卖', '矿', '码', '厕', '奔',
    '奇', '奋', '态', '欧', '垄', '妻', '轰', '顷', '转', '斩',
    '轮', '软', '到', '非', '叔', '肯', '齿', '些', '虎', '虏',
    '肾', '贤', '尚', '旺', '具', '果', '味', '昆', '国', '昌',
    '畅', '明', '易', '昂', '典', '固', '忠', '咐', '呼', '鸣',
    '咏', '呢', '岸', '岩', '帖', '罗', '帜', '岭', '凯', '败',
    '贩', '购', '图', '钓', '制', '知', '垂', '牧', '物', '乖',
    '刮', '秆', '和', '季', '委', '佳', '侍', '供', '使', '例',
    '版', '侄', '侦', '侧', '凭', '侨', '佩', '货', '依', '的',
    '迫', '质', '欣', '征', '往', '爬', '彼', '径', '所', '舍',
    '金', '命', '斧', '爸', '采', '觅', '受', '乳', '贪', '念',
    '贫', '肤', '肺', '肢', '肿', '胀', '朋', '股', '肥', '服',
    '胁', '周', '昏', '鱼', '兔', '狐', '忽', '狗', '备', '饰',
    '饱', '饲', '变', '京', '享', '店', '夜', '庙', '府', '底',
    '剂', '郊', '废', '净', '盲', '放', '刻', '育', '闸', '闹',
    '郑', '券', '卷', '单', '炒', '炊', '炕', '炎', '炉', '沫',
    '浅', '法', '泄', '沿', '泡', '注', '泻', '泳', '泥', '沸',
    '波', '泼', '泽', '治', '怖', '性', '怕', '怜', '怪', '学',
    '宝', '宗', '定', '宜', '审', '宙', '官', '空', '帘', '实',
    '试', '郎', '诗', '肩', '房', '诚', '衬', '衫', '视', '话',
    '诞', '询', '该', '详', '诧', '诌', '词', '译', '君', '灵'
]

# 去重
common_chars = list(set(common_chars))
print(f"常用汉字数量: {len(common_chars)}")

# 如果数量不足1000，添加更多常用字
if len(common_chars) < 1000:
    additional_chars = [
        '物', '格', '式', '能', '破', '碎', '红', '绿', '蓝', '黄',
        '紫', '橙', '灰', '白', '黑', '棕', '粉', '金', '银', '铜',
        '铁', '铝', '锌', '锡', '铅', '汞', '砷', '硫', '氯', '钠',
        '钙', '镁', '钾', '磷', '碳', '氢', '氧', '氮', '氦', '氖',
        '氩', '氪', '氙', '氡', '氟', '溴', '碘', '硼', '硅', '锗',
        '硒', '碲', '锑', '铋', '镓', '铟', '铊', '锗', '锡', '铅',
        '锑', '铋', '钋', '砹', '氡', '钫', '镭', '锕', '钍', '镤',
        '铀', '镎', '钚', '镅', '锔', '锫', '锎', '锿', '镄', '钔',
        '锘', '铹', '钅卢', '钅杜', '钅喜', '钅波', '钅黑', '钅麦', '钅达', '钅仑',
        '镧', '铈', '镨', '钕', '钷', '钐', '铕', '钆', '铽', '镝',
        '钬', '铒', '铥', '镱', '镥', '钪', '钇', '钛', '锆', '铪',
        '钒', '铌', '钽', '铬', '钼', '钨', '锰', '锝', '铼', '铁',
        '钌', '铑', '钯', '银', '镉', '铟', '锡', '锑', '碲', '碘',
        '氙', '铯', '钡', '镧', '铈', '镨', '钕', '钷', '钐', '铕',
        '钆', '铽', '镝', '钬', '铒', '铥', '镱', '镥', '铪', '钽',
        '钨', '铼', '锇', '铱', '铂', '金', '汞', '铊', '铅', '铋',
        '钋', '砹', '氡', '钫', '镭', '锕', '钍', '镤', '铀', '镎',
        '钚', '镅', '锔', '锫', '锎', '锿', '镄', '钔', '锘', '铹',
        '钅卢', '钅杜', '钅喜', '钅波', '钅黑', '钅麦', '钅达', '钅仑', '镧', '铈'
    ]
    # 去重并添加
    additional_chars = list(set(additional_chars))
    common_chars.extend(additional_chars)
    common_chars = list(set(common_chars))
    print(f"添加额外汉字后数量: {len(common_chars)}")

# 加载字符字典
def load_char_dict():
    with open(char_dict_path, 'rb') as f:
        return pickle.load(f)

# 创建目录结构
def create_dirs():
    for dir_name in [output_common_dir, output_other_dir]:
        if not os.path.exists(dir_name):
            os.makedirs(dir_name)
        for sub_dir in ['train', 'test']:
            sub_path = os.path.join(dir_name, sub_dir)
            if not os.path.exists(sub_path):
                os.makedirs(sub_path)

# 处理单个类别目录
def process_class_dir(class_dir, input_path, common_output_path, other_output_path, common_indices):
    class_path = os.path.join(input_path, class_dir)
    if not os.path.isdir(class_path):
        return 0, 0
    
    try:
        class_idx = int(class_dir)
        if class_idx in common_indices:
            # 复制到常用目录
            target_dir = os.path.join(common_output_path, class_dir)
            if not os.path.exists(target_dir):
                os.makedirs(target_dir)
            # 复制文件
            file_count = 0
            for file_name in os.listdir(class_path):
                src_file = os.path.join(class_path, file_name)
                dst_file = os.path.join(target_dir, file_name)
                shutil.copy2(src_file, dst_file)
                file_count += 1
            return file_count, 0
        else:
            # 复制到其他目录
            target_dir = os.path.join(other_output_path, class_dir)
            if not os.path.exists(target_dir):
                os.makedirs(target_dir)
            # 复制文件
            file_count = 0
            for file_name in os.listdir(class_path):
                src_file = os.path.join(class_path, file_name)
                dst_file = os.path.join(target_dir, file_name)
                shutil.copy2(src_file, dst_file)
                file_count += 1
            return 0, file_count
    except Exception as e:
        print(f"处理目录 {class_dir} 时出错: {e}")
        return 0, 0

# 处理数据
def process_data():
    char_dict = load_char_dict()
    create_dirs()
    
    # 创建字符到索引的映射
    char_to_idx = char_dict
    idx_to_char = {v: k for k, v in char_dict.items()}
    
    # 确定常用汉字的索引
    common_indices = set()
    for char in common_chars:
        if char in char_to_idx:
            common_indices.add(char_to_idx[char])
    
    print(f"常用汉字对应的索引数量: {len(common_indices)}")
    
    total_common_files = 0
    total_other_files = 0
    total_classes = 0
    processed_classes = 0
    
    # 处理训练和测试数据
    for data_type in ['train', 'test']:
        input_dir = os.path.join(input_data_dir, data_type)
        common_output_dir = os.path.join(output_common_dir, data_type)
        other_output_dir = os.path.join(output_other_dir, data_type)
        
        if not os.path.exists(input_dir):
            print(f"跳过 {input_dir}，目录不存在")
            continue
        
        # 获取所有类别目录
        class_dirs = os.listdir(input_dir)
        total_classes += len(class_dirs)
        print(f"开始处理 {data_type} 数据，共 {len(class_dirs)} 个类别")
        
        start_time = time.time()
        
        # 遍历所有类别目录
        for i, class_dir in enumerate(class_dirs):
            common_files, other_files = process_class_dir(
                class_dir, input_dir, common_output_dir, other_output_dir, common_indices
            )
            total_common_files += common_files
            total_other_files += other_files
            processed_classes += 1
            
            # 每处理100个类别显示一次进度
            if (i + 1) % 100 == 0 or (i + 1) == len(class_dirs):
                elapsed_time = time.time() - start_time
                avg_time_per_class = elapsed_time / (i + 1)
                remaining_time = avg_time_per_class * (len(class_dirs) - i - 1)
                
                print(f"  进度: {i + 1}/{len(class_dirs)} 类别, "
                      f"常用: {total_common_files} 文件, "
                      f"其他: {total_other_files} 文件, "
                      f"预计剩余: {remaining_time:.1f} 秒")
        
        print(f"处理完成 {data_type} 数据，耗时: {time.time() - start_time:.2f} 秒")
    
    print(f"\n处理完成!")
    print(f"总处理类别数: {processed_classes}/{total_classes}")
    print(f"常用汉字文件数: {total_common_files}")
    print(f"其他汉字文件数: {total_other_files}")
    print(f"常用汉字数据已保存到: {output_common_dir}")
    print(f"其他汉字数据已保存到: {output_other_dir}")

if __name__ == '__main__':
    print("开始处理数据集...")
    start_time = time.time()
    process_data()
    print(f"总耗时: {time.time() - start_time:.2f} 秒")
