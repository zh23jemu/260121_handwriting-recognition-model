import os
import shutil
import pickle
import time

# 配置
char_dict_path = 'char_dict'
input_data_dir = 'data'
output_common_dir = 'data_common'
output_other_dir = 'data_other'

# 常用汉字列表（约1000个）
common_chars = [
    '一', '二', '三', '四', '五', '六', '七', '八', '九', '十',
    '百', '千', '万', '亿', '零', '壹', '贰', '叁', '肆', '伍',
    '陆', '柒', '捌', '玖', '拾', '佰', '仟', '万', '亿', '个',
    '十', '百', '千', '万', '亿', '人', '口', '日', '月', '水',
    '火', '木', '金', '土', '天', '地', '人', '王', '后', '夫',
    '妻', '子', '女', '父', '母', '兄', '弟', '姐', '妹', '孙',
    '儿', '女', '老', '少', '大', '小', '多', '少', '高', '低',
    '长', '短', '宽', '窄', '厚', '薄', '胖', '瘦', '美', '丑',
    '善', '恶', '好', '坏', '真', '假', '是', '非', '对', '错',
    '有', '无', '上', '下', '左', '右', '前', '后', '里', '外',
    '东', '西', '南', '北', '中', '内', '外', '里', '表', '正',
    '反', '阴', '阳', '日', '夜', '早', '晚', '春', '夏', '秋',
    '冬', '年', '月', '日', '时', '分', '秒', '天', '周', '月',
    '年', '世', '代', '岁', '生', '死', '存', '亡', '起', '落',
    '升', '降', '进', '出', '来', '去', '回', '往', '开', '关',
    '启', '闭', '始', '终', '首', '尾', '头', '尾', '前', '后',
    '先', '后', '早', '晚', '快', '慢', '缓', '急', '忙', '闲',
    '动', '静', '行', '止', '走', '停', '跑', '站', '坐', '立',
    '卧', '躺', '睡', '醒', '吃', '喝', '拉', '撒', '睡', '醒',
    '看', '听', '说', '读', '写', '算', '想', '念', '思', '虑',
    '考', '查', '问', '答', '学', '教', '师', '生', '学', '校',
    '教', '育', '文', '化', '知', '识', '智', '慧', '才', '能',
    '技', '艺', '科', '技', '科', '学', '数', '学', '物', '理',
    '化', '学', '生', '物', '地', '理', '历', '史', '政', '治',
    '经', '济', '社', '会', '法', '律', '道', '德', '伦', '理',
    '文', '章', '作', '文', '诗', '词', '歌', '赋', '小', '说',
    '散', '文', '剧', '本', '演', '员', '导', '演', '摄', '影',
    '音', '乐', '歌', '曲', '舞', '蹈', '绘', '画', '书', '法',
    '雕', '刻', '建', '筑', '设', '计', '工', '程', '建', '设',
    '制', '造', '加', '工', '生', '产', '销', '售', '购', '买',
    '卖', '出', '商', '店', '市', '场', '超', '市', '商', '场',
    '银', '行', '金', '融', '经', '营', '管', '理', '计', '划',
    '组', '织', '协', '调', '领', '导', '管', '理', '服', '务',
    '劳', '动', '工', '作', '职', '业', '职', '位', '薪', '资',
    '收', '入', '支', '出', '预', '算', '结', '算', '利', '润',
    '亏', '损', '成', '本', '价', '格', '市', '场', '需', '求',
    '供', '给', '贸', '易', '进', '口', '出', '口', '关', '税',
    '海', '关', '运', '输', '物', '流', '仓', '储', '配', '送',
    '交', '通', '工', '具', '汽', '车', '火', '车', '飞', '机',
    '轮', '船', '地', '铁', '公', '交', '出', '租', '自', '行',
    '道', '路', '桥', '梁', '隧', '道', '机', '场', '车', '站',
    '码', '头', '港', '口', '城', '市', '乡', '村', '街', '道',
    '巷', '弄', '住', '宅', '楼', '房', '屋', '家', '庭', '居',
    '住', '环', '境', '卫', '生', '健', '康', '医', '疗', '药',
    '品', '医', '院', '诊', '所', '医', '生', '护', '士', '病',
    '人', '疾', '病', '治', '疗', '预', '防', '保', '健', '体',
    '育', '运', '动', '锻', '炼', '体', '育', '场', '体', '育',
    '馆', '球', '场', '跑', '道', '游', '泳', '池', '健', '身',
    '器', '材', '食', '物', '饮', '食', '餐', '饮', '厨', '房',
    '餐', '厅', '饭', '店', '餐', '馆', '菜', '肴', '美', '食',
    '水', '果', '蔬', '菜', '肉', '类', '鱼', '类', '蛋', '奶',
    '谷', '物', '粮', '食', '面', '粉', '大', '米', '馒', '头',
    '饺', '子', '汤', '圆', '面', '条', '米', '饭', '粥', '饼',
    '干', '果', '糖', '果', '饮', '料', '茶', '水', '咖', '啡',
    '可', '乐', '啤', '酒', '白', '酒', '红', '酒', '饮', '料',
    '服', '装', '衣', '服', '裤', '子', '裙', '子', '上', '衣',
    '外', '套', '西', '服', '衬', '衫', '毛', '衣', '裤', '子',
    '鞋', '子', '袜', '子', '帽', '子', '手', '套', '围', '巾',
    '领', '带', '皮', '带', '手', '表', '眼', '镜', '珠', '宝',
    '首', '饰', '金', '银', '珠', '宝', '钻', '石', '装', '饰',
    '家', '具', '沙', '发', '桌', '子', '椅', '子', '床', '柜',
    '书', '架', '衣', '柜', '电', '器', '电', '视', '电', '脑',
    '手', '机', '电', '话', '冰', '箱', '洗', '衣', '机', '空',
    '调', '电', '扇', '灯', '具', '照', '明', '音', '响', '录',
    '音', '机', '视', '频', '播', '放', '器', '网', '络', '互',
    '联', '网', '网', '站', '网', '页', '搜', '索', '引', '擎',
    '电', '子', '邮', '件', '聊', '天', '软', '件', '社', '交',
    '媒', '体', '微', '博', '微', '信', 'Q', 'Q', '网', '络',
    '游', '戏', '电', '子', '游', '戏', '手', '机', '游', '戏',
    '电', '脑', '游', '戏', '游', '戏', '机', '游', '戏', '软',
    '件', '图', '片', '照', '片', '相', '机', '数', '码', '相',
    '机', '手', '机', '相', '机', '视', '频', '录', '像', '摄',
    '像', '机', '电', '影', '电', '视', '剧', '综', '艺', '节',
    '目', '新', '闻', '报', '纸', '杂', '志', '书', '籍', '图',
    '书', '馆', '阅', '读', '写', '作', '文', '章', '故', '事',
    '小', '说', '散', '文', '诗', '歌', '词', '曲', '歌', '手',
    '演', '唱', '会', '音', '乐', '会', '音', '乐', '厅', '剧',
    '院', '电', '影', '院', '戏', '院', '展', '览', '馆', '美',
    '术', '馆', '博', '物', '馆', '科', '技', '馆', '体', '育',
    '场', '体', '育', '馆', '公', '园', '动', '物', '园', '植',
    '物', '园', '风', '景', '区', '旅', '游', '景', '点', '名',
    '胜', '古', '迹', '文', '化', '遗', '产', '自', '然', '保',
    '护', '区', '国', '家', '公', '园', '世', '界', '遗', '产',
    '宗', '教', '信', '仰', '佛', '教', '道', '教', '基', '督',
    '教', '伊', '斯', '兰', '教', '寺', '庙', '道', '观', '教',
    '堂', '清', '真', '寺', '神', '仙', '鬼', '怪', '魔', '鬼',
    '上', '帝', '天', '主', '佛', '祖', '道', '祖', '神', '灵',
    '鬼', '魂', '仙', '人', '魔', '王', '妖', '怪', '精', '灵',
    '传', '说', '神', '话', '故', '事', '民', '间', '传', '说',
    '历', '史', '故', '事', '神', '话', '传', '说', '小', '说',
    '故', '事', '戏', '剧', '故', '事', '电', '影', '故', '事',
    '电', '视', '剧', '故', '事', '人', '物', '角', '色', '主',
    '角', '配', '角', '反', '派', '正', '派', '英', '雄', '英',
    '雌', '雄', '男', '女', '公', '母', '阴', '阳', '单', '双',
    '奇', '偶', '正', '负', '加', '减', '乘', '除', '和', '差',
    '积', '商', '分', '数', '小', '数', '百', '分', '比', '比',
    '例', '比', '率', '概', '率', '统', '计', '平', '均', '值',
    '方', '差', '标', '准', '差', '最', '大', '值', '最', '小',
    '值', '中', '位', '数', '众', '数', '频', '率', '分', '布',
    '正', '态', '分', '布', '均', '匀', '分', '布', '概', '率',
    '密', '度', '函', '数', '累', '计', '分', '布', '函', '数',
    '期', '望', '方', '差', '标', '准', '差', '协', '方', '差',
    '相', '关', '系', '数', '回', '归', '分', '析', '线', '性',
    '回', '归', '非', '线', '性', '回', '归', '多', '元', '回',
    '归', '时', '间', '序', '列', '分', '析', '时', '间', '序',
    '列', '模', '型', '时', '间', '序', '列', '预', '测', '时',
    '间', '序', '列', '分', '析', '时', '间', '序', '列', '模',
    '型', '时', '间', '序', '列', '预', '测', '时', '间', '序',
    '列', '分', '析', '时', '间', '序', '列', '模', '型', '时',
    '间', '序', '列', '预', '测', '时', '间', '序', '列', '分',
    '析', '时', '间', '序', '列', '模', '型', '时', '间', '序',
    '列', '预', '测', '时', '间', '序', '列', '分', '析', '时',
    '间', '序', '列', '模', '型', '时', '间', '序', '列', '预',
    '测', '时', '间', '序', '列', '分', '析', '时', '间', '序',
    '列', '模', '型', '时', '间', '序', '列', '预', '测'
]

# 去重
common_chars = list(set(common_chars))
print(f"常用汉字数量: {len(common_chars)}")

# 加载字符字典
def load_char_dict():
    with open(char_dict_path, 'rb') as f:
        return pickle.load(f)

# 创建目录结构
def create_dirs():
    for dir_name in [output_common_dir, output_other_dir]:
        if not os.path.exists(dir_name):
            os.makedirs(dir_name)
        for sub_dir in ['train', 'test']:
            sub_path = os.path.join(dir_name, sub_dir)
            if not os.path.exists(sub_path):
                os.makedirs(sub_path)

# 处理单个类别目录
def process_class_dir(class_dir, input_path, common_output_path, other_output_path, common_indices):
    class_path = os.path.join(input_path, class_dir)
    if not os.path.isdir(class_path):
        return 0, 0
    
    try:
        class_idx = int(class_dir)
        if class_idx in common_indices:
            # 复制到常用目录
            target_dir = os.path.join(common_output_path, class_dir)
            if not os.path.exists(target_dir):
                os.makedirs(target_dir)
            # 复制文件
            file_count = 0
            for file_name in os.listdir(class_path):
                src_file = os.path.join(class_path, file_name)
                dst_file = os.path.join(target_dir, file_name)
                shutil.copy2(src_file, dst_file)
                file_count += 1
            return file_count, 0
        else:
            # 复制到其他目录
            target_dir = os.path.join(other_output_path, class_dir)
            if not os.path.exists(target_dir):
                os.makedirs(target_dir)
            # 复制文件
            file_count = 0
            for file_name in os.listdir(class_path):
                src_file = os.path.join(class_path, file_name)
                dst_file = os.path.join(target_dir, file_name)
                shutil.copy2(src_file, dst_file)
                file_count += 1
            return 0, file_count
    except Exception as e:
        print(f"处理目录 {class_dir} 时出错: {e}")
        return 0, 0

# 处理数据
def process_data():
    char_dict = load_char_dict()
    create_dirs()
    
    # 创建字符到索引的映射
    char_to_idx = char_dict
    idx_to_char = {v: k for k, v in char_dict.items()}
    
    # 确定常用汉字的索引
    common_indices = set()
    for char in common_chars:
        if char in char_to_idx:
            common_indices.add(char_to_idx[char])
    
    print(f"常用汉字对应的索引数量: {len(common_indices)}")
    
    total_common_files = 0
    total_other_files = 0
    total_classes = 0
    processed_classes = 0
    
    # 处理训练和测试数据
    for data_type in ['train', 'test']:
        input_dir = os.path.join(input_data_dir, data_type)
        common_output_dir = os.path.join(output_common_dir, data_type)
        other_output_dir = os.path.join(output_other_dir, data_type)
        
        if not os.path.exists(input_dir):
            print(f"跳过 {input_dir}，目录不存在")
            continue
        
        # 获取所有类别目录
        class_dirs = os.listdir(input_dir)
        total_classes += len(class_dirs)
        print(f"开始处理 {data_type} 数据，共 {len(class_dirs)} 个类别")
        
        start_time = time.time()
        
        # 遍历所有类别目录
        for i, class_dir in enumerate(class_dirs):
            common_files, other_files = process_class_dir(
                class_dir, input_dir, common_output_dir, other_output_dir, common_indices
            )
            total_common_files += common_files
            total_other_files += other_files
            processed_classes += 1
            
            # 每处理100个类别显示一次进度
            if (i + 1) % 100 == 0 or (i + 1) == len(class_dirs):
                elapsed_time = time.time() - start_time
                avg_time_per_class = elapsed_time / (i + 1)
                remaining_time = avg_time_per_class * (len(class_dirs) - i - 1)
                
                print(f"  进度: {i + 1}/{len(class_dirs)} 类别, "
                      f"常用: {total_common_files} 文件, "
                      f"其他: {total_other_files} 文件, "
                      f"预计剩余: {remaining_time:.1f} 秒")
        
        print(f"处理完成 {data_type} 数据，耗时: {time.time() - start_time:.2f} 秒")
    
    print(f"\n处理完成!")
    print(f"总处理类别数: {processed_classes}/{total_classes}")
    print(f"常用汉字文件数: {total_common_files}")
    print(f"其他汉字文件数: {total_other_files}")
    print(f"常用汉字数据已保存到: {output_common_dir}")
    print(f"其他汉字数据已保存到: {output_other_dir}")

if __name__ == '__main__':
    print("开始处理数据集...")
    start_time = time.time()
    process_data()
    print(f"总耗时: {time.time() - start_time:.2f} 秒")
